<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞–ª–æ–≥–æ–≤ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ –æ—Ç RBMGROUP.RU</title>
  <style>
    :root { --bg:#0b1220; --card:#111a2e; --muted:#97a3b6; --text:#e8eefc; --accent:#4aa3ff; --danger:#ff5b5b; --ok:#43d17a; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#070b14, #0b1220);color:var(--text);}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    h1{font-size:20px;margin:10px 0 18px}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:rgba(17,26,46,.92);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:14px;box-shadow:0 10px 25px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:640px){.row.two{grid-template-columns:1fr 1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"]{
      width:100%;padding:12px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);color:var(--text);outline:none;
    }
    input[disabled]{opacity:.55}
    .seg{display:flex;gap:8px;flex-wrap:wrap}
    .seg button{
      border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);color:var(--text);
      padding:10px 12px;border-radius:10px;cursor:pointer;transition:.15s; font-size:13px;
    }
    .seg button.active{border-color:rgba(74,163,255,.9);box-shadow:0 0 0 3px rgba(74,163,255,.15)}
    .seg button:disabled{opacity:.35; cursor:not-allowed; border-color:rgba(255,255,255,.08); box-shadow:none;}
    .hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px}
    .warn{margin-top:10px;padding:10px;border-radius:12px;border:1px solid rgba(255,91,91,.28);background:rgba(255,91,91,.08);color:#ffd3d3;font-size:13px;line-height:1.35}
    .ok{margin-top:10px;padding:10px;border-radius:12px;border:1px solid rgba(67,209,122,.25);background:rgba(67,209,122,.08);color:#c8ffe0;font-size:13px}
    .result-line{display:flex;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px dashed rgba(255,255,255,.08)}
    .result-line:last-child{border-bottom:none}
    .k{color:var(--muted);font-size:13px}
    .v{font-weight:650; text-align:right; white-space:nowrap}
    .pos{color:var(--ok)}
    .neg{color:var(--danger)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);color:var(--text);cursor:pointer;
    }
    .btn.primary{border-color:rgba(74,163,255,.7);background:rgba(74,163,255,.14)}
    .small{font-size:12px;color:var(--muted)}
    .split{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .tag{display:inline-block;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.12);color:var(--muted)}
    .formula{
      margin-top:10px;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
      white-space:pre-wrap;
    }

    /* === –ë–∞–Ω–Ω–µ—Ä: —Ñ–∏–∫—Å –±–µ–ª—ã—Ö –ø–æ–ª–µ–π (–æ–±—Ä–µ–∑–∫–∞ canvas) === */
    .topBanner{
      display:block;
      margin: 0 0 14px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 10px 25px rgba(0,0,0,.25);
      transition: transform .15s, box-shadow .15s;
      text-decoration:none;

      /* –∫–ª—é—á: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
      height: 140px;
      background:#0b1220;
    }
    .topBanner img{
      width:100%;
      height:100%;
      display:block;

      /* –∫–ª—é—á: –æ–±—Ä–µ–∑–∞–µ–º –±–µ–ª—ã–µ –ø–æ–ª—è */
      object-fit: cover;
      object-position: center;
    }
    .topBanner:hover{transform: translateY(-1px); box-shadow:0 14px 35px rgba(0,0,0,.35)}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.14);
      padding:8px 10px;border-radius:12px;color:var(--muted);font-size:12px
    }
    .expRow{display:grid;grid-template-columns:1.3fr .7fr auto;gap:8px;align-items:center;margin-top:8px}
    .expRow .xbtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);color:var(--text);
      padding:10px 10px;border-radius:10px;cursor:pointer;
    }
    @media(max-width:520px){
      .expRow{grid-template-columns:1fr 1fr auto}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- –ë–∞–Ω–Ω–µ—Ä -->
    <a href="https://rbmgroup.ru" class="topBanner" target="_blank" rel="noopener">
      <img src="rbm-banner.png" alt="RBMGROUP ‚Äî –≤—Å—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞">
    </a>

    <h1>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞–ª–æ–≥–æ–≤ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ –æ—Ç RBMGROUP.RU</h1>

    <div class="grid">
      <!-- INPUTS -->
      <div class="card">
        <div class="row">
          <div>
            <label>–ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞</label>
            <input id="addr" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–ü–±, —É–ª. –†—É–±–∏–Ω—à—Ç–µ–π–Ω–∞, 10" />
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏, ‚ÇΩ</label>
            <input id="salePrice" type="text" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 20 000 000" />
          </div>
          <div>
            <label>–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å, ‚ÇΩ</label>
            <input id="cadastral" type="text" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 11 283 000" />
          </div>
        </div>

        <div style="margin-top:14px">
          <label>–ì–æ–¥–æ–≤–∞—è –≤—ã—Ä—É—á–∫–∞ –ø–æ—Å–ª–µ –ø—Ä–æ–¥–∞–∂–∏ (–¥–∏–∞–ø–∞–∑–æ–Ω)</label>
          <div class="seg" id="incomeBand">
            <button data-band="A" class="active">–¥–æ 20 –º–ª–Ω</button>
            <button data-band="B">20‚Äì250 –º–ª–Ω</button>
            <button data-band="C">250‚Äì450 –º–ª–Ω</button>
            <button data-band="D">&gt; 450 –º–ª–Ω</button>
          </div>
        </div>

        <div style="margin-top:14px">
          <label>–ù–∞–ª–æ–≥–æ–≤—ã–π —Ä–µ–∂–∏–º –ò–ü</label>
          <div class="seg" id="taxRegime">
            <button data-reg="USN_6" class="active">6% —Å –¥–æ—Ö–æ–¥–æ–≤</button>
            <button data-reg="USN_7">7% –¥–æ—Ö–æ–¥—ã ‚àí —Ä–∞—Å—Ö–æ–¥—ã</button>
            <button data-reg="OSNO" style="display:none">–û–°–ù–û</button>
          </div>
          <div class="hint" id="osnoHint" style="display:none">
            –í—ã–±—Ä–∞–Ω –¥–∏–∞–ø–∞–∑–æ–Ω –≤—ã—Ä—É—á–∫–∏ &gt; 450 –º–ª–Ω ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª–µ–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç. –î–ª—è —É–ø—Ä–æ—â—ë–Ω–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —Å—Ç–∞–≤–∫–∏ 10% (–Ω–∞–ª–æ–≥) –∏ 10% (–ù–î–°).
          </div>
        </div>

        <div style="margin-top:14px" id="expensesWrap" hidden>
          <label>–†–∞—Å—Ö–æ–¥—ã, ‚ÇΩ (–ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ) ‚Äî –¥–ª—è —Ä–µ–∂–∏–º–∞ 7%</label>
          <input id="expenses" type="text" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 3 000 000 (–∏–ª–∏ 0)" />
          <div class="hint">–î–ª—è –£–°–ù 7% –±–∞–∑–∞ = max(–¥–æ—Ö–æ–¥ ‚àí —Ä–∞—Å—Ö–æ–¥—ã, 0). –°—é–¥–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤—è—Ç—Å—è ‚Äú–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã‚Äù –Ω–∏–∂–µ.</div>
        </div>

        <div class="split"></div>

        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
            <div class="tag">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
            <button class="btn" id="addExpenseBtn">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
          </div>

          <div id="extraExpensesList"></div>
          <div class="hint">–≠—Ç–∏ —Ä–∞—Å—Ö–æ–¥—ã —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è: (1) –≤ ‚Äú–ù–∞ —Ä—É–∫–∏‚Äù, (2) –≤ —Ä–µ–∂–∏–º–µ 7% (–∫–∞–∫ —Ä–∞—Å—Ö–æ–¥—ã), (3) –≤ —Ä–µ–∂–∏–º–µ ‚Äú–ø–µ—Ä–µ–∫—É–ø‚Äù.</div>
        </div>

        <div class="split"></div>

        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div>
            <div class="tag">–†–µ–∂–∏–º ‚Äú–ø–µ—Ä–µ–∫—É–ø‚Äù</div>
            <div class="hint" style="margin-top:6px">–ü—Ä–∏–±—ã–ª—å –∏ % –≥–æ–¥–æ–≤—ã—Ö —Å—á–∏—Ç–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö –Ω–∞–ª–æ–≥–æ–≤. –ü—Ä–∏–±—ã–ª—å ‚Äî –ø–æ —Ü–µ–Ω–µ –ø—Ä–æ–¥–∞–∂–∏. –ö–∞–¥–∞—Å—Ç—Ä –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –Ω–∞–ª–æ–≥–∏.</div>
          </div>
          <div class="seg" id="flipToggle">
            <button data-flip="OFF" class="active">–í—ã–∫–ª—é—á–µ–Ω</button>
            <button data-flip="ON">–í–∫–ª—é—á–∏—Ç—å</button>
          </div>
        </div>

        <div style="margin-top:14px" id="flipBlock" hidden>
          <div class="row two">
            <div>
              <label>–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏, ‚ÇΩ</label>
              <input id="buyPrice" type="text" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 18 000 000" />
            </div>
            <div>
              <label>–î–Ω–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 180)</label>
              <input id="flipDays" type="text" inputmode="numeric" placeholder="180" />
            </div>
          </div>

          <div class="row two" style="margin-top:10px">
            <div>
              <label>–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã –ø–µ—Ä–µ–∫—É–ø–∞, ‚ÇΩ (—Ä–µ–º–æ–Ω—Ç/—Å–¥–µ–ª–∫–∞ –∏ —Ç.–ø.)</label>
              <input id="flipExtraExpenses" type="text" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 200 000 (–∏–ª–∏ 0)" />
            </div>
            <div>
              <label>% –≥–æ–¥–æ–≤—ã—Ö (–ø–æ—Å–ª–µ –Ω–∞–ª–æ–≥–æ–≤)</label>
              <input id="flipApr" type="text" disabled value="‚Äî" />
            </div>
          </div>
        </div>

        <div class="btns">
          <button class="btn" id="resetBtn">–°–±—Ä–æ—Å</button>
          <div class="pill" title="–°—Å—ã–ª–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –º–æ–∂–Ω–æ –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏">
            üîó –°—Å—ã–ª–∫–∞ —Å —Ä–∞—Å—á—ë—Ç–æ–º: –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
          </div>
        </div>

        <div class="hint" style="margin-top:12px">
          –ü–µ—Ä–µ—Å—á—ë—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏.
        </div>
      </div>

      <!-- RESULT -->
      <div class="card">
        <div class="small">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>

        <div style="margin-top:10px">
          <div class="result-line"><div class="k">–ë–∞–∑–∞ –¥–ª—è –Ω–∞–ª–æ–≥–æ–≤ (–°–ü–±)</div><div class="v" id="rTaxBase">‚Äî</div></div>

          <div class="result-line"><div class="k">–°—Ç–∞–≤–∫–∞ –ù–î–°</div><div class="v" id="rVatRate">‚Äî</div></div>
          <div class="result-line"><div class="k">–ù–î–° –∫ —É–ø–ª–∞—Ç–µ</div><div class="v neg" id="rVat">‚Äî</div></div>

          <div class="split"></div>

          <div class="result-line"><div class="k">–ù–∞–ª–æ–≥ —Å –ø—Ä–æ–¥–∞–∂–∏ (–¥–æ –∑–∞—á—ë—Ç–∞ –≤–∑–Ω–æ—Å–æ–≤)</div><div class="v neg" id="rMainTaxBefore">‚Äî</div></div>

          <div class="result-line" id="contribRow0"><div class="k">–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è –∑–∞ —Å—á—ë—Ç –≤–∑–Ω–æ—Å–æ–≤ –ò–ü (–∑–∞—á—ë—Ç)</div><div class="v pos" id="rContribCredit">‚Äî</div></div>

          <div class="result-line" id="contribRow1"><div class="k">–í–∑–Ω–æ—Å—ã –ò–ü (—Ñ–∏–∫—Å. 2026)</div><div class="v neg" id="rContribFixed">‚Äî</div></div>
          <div class="result-line" id="contribRow2"><div class="k">–í–∑–Ω–æ—Å—ã –ò–ü (1% —Å–≤—ã—à–µ 300k)</div><div class="v neg" id="rContribExtra">‚Äî</div></div>
          <div class="result-line" id="contribRow3"><div class="k">–í–∑–Ω–æ—Å—ã –ò–ü (–∏—Ç–æ–≥–æ)</div><div class="v neg" id="rContribTotal">‚Äî</div></div>

          <div class="result-line"><div class="k">–ù–∞–ª–æ–≥ –∫ —É–ø–ª–∞—Ç–µ (–ø–æ—Å–ª–µ –∑–∞—á—ë—Ç–∞ –≤–∑–Ω–æ—Å–æ–≤)</div><div class="v neg" id="rMainTaxAfter">‚Äî</div></div>

          <div class="split"></div>

          <div class="result-line"><div class="k">–ò—Ç–æ–≥–æ –∫ —É–ø–ª–∞—Ç–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤—É (–ù–î–° + –Ω–∞–ª–æ–≥ + –≤–∑–Ω–æ—Å—ã)</div><div class="v neg" id="rTotalPayable">‚Äî</div></div>
          <div class="result-line"><div class="k">–ù–∞ —Ä—É–∫–∏ (–ø–æ—Å–ª–µ –≤—Å–µ—Ö –Ω–∞–ª–æ–≥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤)</div><div class="v pos" id="rNetHands">‚Äî</div></div>

          <div class="hint" id="bandDeltaHint" style="margin-top:10px"></div>

          <div class="split"></div>

          <div id="flipResults" hidden>
            <div class="result-line"><div class="k">‚Äú–ü–µ—Ä–µ–∫—É–ø‚Äù</div><div class="v" id="rFlipStatus">‚Äî</div></div>
            <div class="result-line"><div class="k">–í—ã—Ä—É—á–∫–∞ (—Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏)</div><div class="v pos" id="rFlipRevenue">‚Äî</div></div>
            <div class="result-line"><div class="k">–ó–∞—Ç—Ä–∞—Ç—ã (–ø–æ–∫—É–ø–∫–∞ + –¥–æ–ø.)</div><div class="v neg" id="rFlipCosts">‚Äî</div></div>
            <div class="result-line"><div class="k">–ù–∞–ª–æ–≥–∏/–≤–∑–Ω–æ—Å—ã –ø—Ä–∏ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–∂–µ</div><div class="v neg" id="rFlipTaxes">‚Äî</div></div>
            <div class="result-line"><div class="k">–ü—Ä–∏–±—ã–ª—å –ø–µ—Ä–µ–∫—É–ø–∞ (–ø–æ—Å–ª–µ –Ω–∞–ª–æ–≥–æ–≤)</div><div class="v" id="rFlipProfitNet">‚Äî</div></div>
            <div class="result-line"><div class="k">% –≥–æ–¥–æ–≤—ã—Ö (–ø–æ—Å–ª–µ –Ω–∞–ª–æ–≥–æ–≤)</div><div class="v" id="rFlipAPR">‚Äî</div></div>
            <div class="split"></div>
          </div>

          <div class="btns">
            <button class="btn primary" id="toggleFormulaBtn">–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É–ª—ã</button>
            <button class="btn" id="copyBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å—á—ë—Ç</button>
            <button class="btn" id="copyLinkBtn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
          </div>

          <div id="formulaBox" class="formula" hidden>‚Äî</div>
        </div>

        <div id="message"></div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  // ====== –í–ó–ù–û–°–´ –ò–ü 2026 ======
  const FIXED_IP_CONTRIB_2026 = 57390;
  const EXTRA_RATE = 0.01;
  const EXTRA_THRESHOLD = 300000;
  const EXTRA_CAP = 321818;

  // ====== –û–°–ù–û (—É–ø—Ä–æ—â—ë–Ω–Ω–æ –¥–ª—è >450 –º–ª–Ω) ======
  const OSNO_TAX_RATE = 0.10; // –Ω–∞–ª–æ–≥
  const OSNO_VAT_RATE = 0.10; // –ù–î–°

  // ====== state ======
  let state = {
    band: "A",
    reg: "USN_6",
    flip: "OFF",
    showFormula: false,
    extraExpenses: []
  };

  // ====== helpers ======
  function parseMoney(str) {
    if (str == null) return 0;
    const cleaned = String(str).replace(/[^\d.]/g, "");
    if (!cleaned) return 0;
    return Number(cleaned);
  }
  function fmtInt(n){
    if (!isFinite(n)) return "‚Äî";
    return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }
  function fmtMoney(n) {
    if (!isFinite(n)) return "‚Äî";
    return fmtInt(n) + " ‚ÇΩ";
  }
  function outflow(n){ return "‚àí " + fmtMoney(n); }
  function inflow(n){ return fmtMoney(n); }
  function plus(n){ return "+ " + fmtMoney(n); }
  function pct(x){ return (x*100).toFixed(0) + "%"; }

  function bandHuman(band){
    return ({A:"–¥–æ 20 –º–ª–Ω",B:"20‚Äì250 –º–ª–Ω",C:"250‚Äì450 –º–ª–Ω",D:"> 450 –º–ª–Ω"})[band] || "‚Äî";
  }

  function formatInputThousands(input) {
    const raw = input.value.replace(/[^\d]/g, "");
    if (!raw) { input.value = ""; return; }
    input.value = raw.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }

  function setActive(containerId, attr, value) {
    const wrap = $(containerId);
    [...wrap.querySelectorAll("button")].forEach(btn => {
      btn.classList.toggle("active", btn.getAttribute(attr) === value);
    });
  }

  // ====== Extra expenses UI ======
  function sumExtraExpenses(){
    return state.extraExpenses.reduce((s,x)=>s + (Number(x.amount)||0), 0);
  }
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
  function renderExtraExpenses(){
    const box = $("extraExpensesList");
    box.innerHTML = "";
    state.extraExpenses.forEach((e, idx) => {
      const row = document.createElement("div");
      row.className = "expRow";
      row.innerHTML = `
        <input type="text" data-exp-name="${idx}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞" value="${escapeHtml(e.name || "")}">
        <input type="text" data-exp-amt="${idx}" inputmode="numeric" placeholder="–°—É–º–º–∞, ‚ÇΩ" value="${e.amount ? fmtInt(e.amount) : ""}">
        <button class="xbtn" data-exp-del="${idx}" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
      `;
      box.appendChild(row);
    });

    box.querySelectorAll("[data-exp-name]").forEach(inp=>{
      inp.addEventListener("input", (ev)=>{
        const i = Number(ev.target.getAttribute("data-exp-name"));
        state.extraExpenses[i].name = ev.target.value;
        render();
      });
    });
    box.querySelectorAll("[data-exp-amt]").forEach(inp=>{
      inp.addEventListener("input", (ev)=>{
        formatInputThousands(ev.target);
        const i = Number(ev.target.getAttribute("data-exp-amt"));
        state.extraExpenses[i].amount = parseMoney(ev.target.value);
        render();
      });
    });
    box.querySelectorAll("[data-exp-del]").forEach(btn=>{
      btn.addEventListener("click", (ev)=>{
        const i = Number(ev.target.getAttribute("data-exp-del"));
        state.extraExpenses.splice(i,1);
        renderExtraExpenses();
        render();
      });
    });
  }

  $("addExpenseBtn").addEventListener("click", ()=>{
    state.extraExpenses.push({name:"", amount:0});
    renderExtraExpenses();
    render();
  });

  // ====== –¥–æ—Ö–æ–¥–Ω—ã–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ –±–∞–∑–µ –¥–ª—è –Ω–∞–ª–æ–≥–æ–≤ ======
  function updateBandAvailability(taxBase) {
    const btnA = $("incomeBand").querySelector('button[data-band="A"]');
    const btnB = $("incomeBand").querySelector('button[data-band="B"]');
    const btnC = $("incomeBand").querySelector('button[data-band="C"]');
    const btnD = $("incomeBand").querySelector('button[data-band="D"]');

    const over20 = taxBase > 20_000_000;
    const over250 = taxBase > 250_000_000;
    const over450 = taxBase > 450_000_000;

    btnA.disabled = over20;
    btnB.disabled = over250;
    btnC.disabled = over450;
    btnD.disabled = false;

    const cur = state.band;
    if ((cur === "A" && btnA.disabled) || (cur === "B" && btnB.disabled) || (cur === "C" && btnC.disabled)) {
      if (!btnB.disabled) state.band = "B";
      else if (!btnC.disabled) state.band = "C";
      else state.band = "D";
      setActive("incomeBand", "data-band", state.band);
    }

    if (over450 && state.band !== "D") {
      state.band = "D";
      setActive("incomeBand", "data-band", "D");
    }
  }

  // ====== —Ä–µ–∂–∏–º—ã: –ª–æ–≥–∏–∫–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è –û–°–ù–û –ø—Ä–∏ D ======
  function applyRegimeRules() {
    const isD = (state.band === "D");

    const btn6 = $("taxRegime").querySelector('button[data-reg="USN_6"]');
    const btn7 = $("taxRegime").querySelector('button[data-reg="USN_7"]');
    const btnO = $("taxRegime").querySelector('button[data-reg="OSNO"]');
    const osnoHint = $("osnoHint");

    if (isD) {
      btnO.style.display = "";
      btn6.disabled = true;
      btn7.disabled = true;
      btnO.disabled = false;

      state.reg = "OSNO";
      setActive("taxRegime","data-reg","OSNO");

      $("expensesWrap").hidden = true;
      osnoHint.style.display = "";
    } else {
      btnO.style.display = "none";
      btn6.disabled = false;
      btn7.disabled = false;

      if (state.reg === "OSNO") {
        state.reg = "USN_6";
        setActive("taxRegime","data-reg","USN_6");
      }

      $("expensesWrap").hidden = (state.reg === "USN_6");
      osnoHint.style.display = "none";
    }
  }

  // ====== events ======
  ["salePrice","cadastral","expenses","buyPrice","flipExtraExpenses","flipDays"].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("input", ()=>{
      formatInputThousands(el);
      render();
    });
  });

  $("addr").addEventListener("input", render);

  $("incomeBand").addEventListener("click", (e) => {
    const b = e.target?.getAttribute?.("data-band");
    if (!b || e.target.disabled) return;
    state.band = b;
    setActive("incomeBand", "data-band", b);
    applyRegimeRules();
    render();
  });

  $("taxRegime").addEventListener("click", (e) => {
    const r = e.target?.getAttribute?.("data-reg");
    if (!r) return;
    if (state.band === "D") return;

    state.reg = r;
    setActive("taxRegime", "data-reg", r);
    $("expensesWrap").hidden = (r === "USN_6");
    render();
  });

  $("flipToggle").addEventListener("click", (e) => {
    const f = e.target?.getAttribute?.("data-flip");
    if (!f) return;
    state.flip = f;
    setActive("flipToggle", "data-flip", f);
    $("flipBlock").hidden = (f === "OFF");
    $("flipResults").hidden = (f === "OFF");
    render();
  });

  $("toggleFormulaBtn").addEventListener("click", () => {
    state.showFormula = !state.showFormula;
    $("formulaBox").hidden = !state.showFormula;
    $("toggleFormulaBtn").textContent = state.showFormula ? "–°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É–ª—ã" : "–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É–ª—ã";
    render();
  });

  $("resetBtn").addEventListener("click", () => {
    $("addr").value = "";
    $("salePrice").value = "";
    $("cadastral").value = "";
    $("expenses").value = "";

    $("buyPrice").value = "";
    $("flipExtraExpenses").value = "";
    $("flipDays").value = "180";
    $("flipApr").value = "‚Äî";

    state.extraExpenses = [];
    renderExtraExpenses();

    state.band = "A";
    state.reg = "USN_6";
    state.flip = "OFF";
    setActive("incomeBand","data-band","A");
    setActive("taxRegime","data-reg","USN_6");
    setActive("flipToggle","data-flip","OFF");

    $("expensesWrap").hidden = true;
    $("flipBlock").hidden = true;
    $("flipResults").hidden = true;

    state.showFormula = false;
    $("formulaBox").hidden = true;
    $("toggleFormulaBtn").textContent = "–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É–ª—ã";

    $("message").innerHTML = "";
    applyRegimeRules();
    render();
  });

  // ====== calc ======
  function calcSale({salePrice, cadastral, band, regime, expenses}) {
    const warnings = [];
    const taxBase = Math.max(salePrice, cadastral);

    if (salePrice > 0 && cadastral > 0 && salePrice < cadastral) {
      warnings.push("–°–ü–±: —Ü–µ–Ω–∞ –Ω–∏–∂–µ –∫–∞–¥–∞—Å—Ç—Ä–æ–≤–æ–π ‚Äî –¥–ª—è –Ω–∞–ª–æ–≥–æ–≤ –±–µ—Ä—ë–º –∫–∞–¥–∞—Å—Ç—Ä–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å.");
    }
    if (band === "D") {
      warnings.push("–í—ã–±—Ä–∞–Ω –¥–∏–∞–ø–∞–∑–æ–Ω –≤—ã—Ä—É—á–∫–∏ > 450 –º–ª–Ω ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –±–æ–ª–µ–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Å—á—ë—Ç. –ó–¥–µ—Å—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ (10% –Ω–∞–ª–æ–≥ –∏ 10% –ù–î–°).");
    }

    let vatRate = 0;
    let mainRate = 0;
    let mainTaxBase = taxBase;

    if (regime === "OSNO") {
      vatRate = OSNO_VAT_RATE;
      mainRate = OSNO_TAX_RATE;
      mainTaxBase = taxBase;
    } else {
      vatRate = (band === "A") ? 0 : (band === "B" ? 0.05 : 0.07);
      if (regime === "USN_6") {
        mainRate = 0.06;
        mainTaxBase = taxBase;
      } else {
        mainRate = 0.07;
        mainTaxBase = Math.max(taxBase - expenses, 0);
      }
    }

    const vat = taxBase * vatRate;
    const mainBefore = mainTaxBase * mainRate;

    let contribFixed = 0, contribExtra = 0, contribTotal = 0, baseForExtra = 0;
    let credit = 0;
    let mainAfter = mainBefore;

    if (regime !== "OSNO") {
      contribFixed = FIXED_IP_CONTRIB_2026;
      baseForExtra = (regime === "USN_6") ? taxBase : mainTaxBase;

      contribExtra = Math.max(baseForExtra - EXTRA_THRESHOLD, 0) * EXTRA_RATE;
      contribExtra = Math.min(contribExtra, EXTRA_CAP);

      contribTotal = contribFixed + contribExtra;

      credit = Math.min(contribTotal, mainBefore);
      mainAfter = Math.max(mainBefore - credit, 0);
    }

    const totalPayable = vat + mainAfter + contribTotal;

    return {
      taxBase,
      vatRate, vat,
      mainRate, mainTaxBase,
      mainBefore, mainAfter,
      contribFixed, contribExtra, contribTotal,
      credit,
      totalPayable,
      warnings,
      baseForExtra
    };
  }

  function nearestBandDeltaText(rBase, baseInputs){
    const {salePrice, cadastral, regime, expenses} = baseInputs;
    const thresholds = [
      {band:"A", next:"B", t:20_000_000},
      {band:"B", next:"C", t:250_000_000},
      {band:"C", next:"D", t:450_000_000}
    ];

    function calcTotalForBand(band){
      let reg = regime;
      if (band === "D") reg = "OSNO";
      return calcSale({salePrice, cadastral, band, regime: reg, expenses}).totalPayable;
    }

    const curBand = state.band;
    if (curBand === "D") return "";

    const row = thresholds.find(x=>x.band===curBand) || thresholds.find(x=>x.next===curBand);
    if(!row) return "";

    const curTotal = calcTotalForBand(curBand);

    if (curBand === row.band){
      const nextTotal = calcTotalForBand(row.next);
      const diff = nextTotal - curTotal;
      if (diff > 0.5) {
        return `<span class="neg">–ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –≤—ã—Ä—É—á–∫–∏ ${fmtInt(row.t)} ‚ÇΩ –∏—Ç–æ–≥ –∫ —É–ø–ª–∞—Ç–µ —É–≤–µ–ª–∏—á–∏—Ç—Å—è –Ω–∞ ${fmtInt(diff)} ‚ÇΩ</span>`;
      }
      return "";
    }

    if (curBand === row.next && rBase <= row.t){
      const prevTotal = calcTotalForBand(row.band);
      const diff = curTotal - prevTotal;
      if (diff > 0.5) {
        return `<span class="pos">–ï—Å–ª–∏ –≤—ã—Ä—É—á–∫–∞ –æ–∫–∞–∂–µ—Ç—Å—è ‚â§ ${fmtInt(row.t)} ‚ÇΩ –∏—Ç–æ–≥ –∫ —É–ø–ª–∞—Ç–µ —Å–Ω–∏–∑–∏—Ç—Å—è –Ω–∞ ${fmtInt(diff)} ‚ÇΩ</span>`;
      }
    }
    return "";
  }

  function calcAll() {
    const salePrice = parseMoney($("salePrice").value);
    const cadastral = parseMoney($("cadastral").value);
    const manualExpenses = parseMoney($("expenses").value);

    const extra = sumExtraExpenses();
    const expenses = (state.reg === "USN_7") ? (manualExpenses + extra) : 0;

    const taxBasePreview = Math.max(salePrice, cadastral);
    updateBandAvailability(taxBasePreview);
    applyRegimeRules();

    const sale = calcSale({
      salePrice,
      cadastral,
      band: state.band,
      regime: state.reg,
      expenses
    });

    const totalExtraCosts = extra;
    const netHands = salePrice - sale.totalPayable - totalExtraCosts;

    const flipEnabled = (state.flip === "ON");
    const buyPrice = parseMoney($("buyPrice").value);
    const flipExtraCosts = parseMoney($("flipExtraExpenses").value);
    const days = Math.max(parseMoney($("flipDays").value) || 180, 1);

    let flip = { enabled: flipEnabled, days, revenue:0, costs:0, taxes:0, profitNet:0, aprNet:null };

    if (flipEnabled) {
      const revenue = salePrice;
      const costs = buyPrice + flipExtraCosts + totalExtraCosts;
      const taxes = sale.totalPayable;
      const profitNet = revenue - costs - taxes;

      flip.revenue = revenue;
      flip.costs = costs;
      flip.taxes = taxes;
      flip.profitNet = profitNet;

      if (costs > 0) {
        const apr = (profitNet / costs) * (365 / days);
        flip.aprNet = apr;
        $("flipApr").value = (apr * 100).toFixed(1) + "%";
      } else {
        $("flipApr").value = "‚Äî";
      }
    } else {
      $("flipApr").value = "‚Äî";
    }

    return { addr: $("addr").value || "", salePrice, cadastral, expensesManual: manualExpenses, extraCosts: totalExtraCosts, expenses, sale, flip, netHands };
  }

  function buildFormulaText(r) {
    const s = r.sale;
    const salePrice = r.salePrice;
    const cad = r.cadastral;

    const lines = [];
    lines.push("1) –ë–∞–∑–∞ –¥–ª—è –Ω–∞–ª–æ–≥–æ–≤ (–°–ü–±):");
    lines.push(`taxBase = max(—Ü–µ–Ω–∞–ü—Ä–æ–¥–∞–∂–∏, –∫–∞–¥–∞—Å—Ç—Ä) = max(${fmtInt(salePrice)}, ${fmtInt(cad)}) = ${fmtInt(s.taxBase)}`);

    lines.push("");
    lines.push("2) –ù–î–° –∫ —É–ø–ª–∞—Ç–µ:");
    lines.push(`–ù–î–° = taxBase √ó —Å—Ç–∞–≤–∫–∞–ù–î–° = ${fmtInt(s.taxBase)} √ó ${pct(s.vatRate)} = ${fmtInt(s.vat)}`);

    lines.push("");
    lines.push("3) –ù–∞–ª–æ–≥ —Å –ø—Ä–æ–¥–∞–∂–∏ (–¥–æ –∑–∞—á—ë—Ç–∞ –≤–∑–Ω–æ—Å–æ–≤):");
    if (state.reg === "USN_6") {
      lines.push(`–Ω–∞–ª–æ–≥–ë–∞–∑–∞ = taxBase = ${fmtInt(s.taxBase)}`);
      lines.push(`–Ω–∞–ª–æ–≥–î–æ = –Ω–∞–ª–æ–≥–ë–∞–∑–∞ √ó 6% = ${fmtInt(s.mainBefore)}`);
    } else if (state.reg === "USN_7") {
      lines.push(`—Ä–∞—Å—Ö–æ–¥—ã = —Ä—É—á–Ω—ã–µ + –¥–æ–ø–†–∞—Å—Ö–æ–¥—ã = ${fmtInt(r.expensesManual)} + ${fmtInt(r.extraCosts)} = ${fmtInt(r.expenses)}`);
      lines.push(`–Ω–∞–ª–æ–≥–ë–∞–∑–∞ = max(taxBase ‚àí —Ä–∞—Å—Ö–æ–¥—ã, 0) = max(${fmtInt(s.taxBase)} ‚àí ${fmtInt(r.expenses)}, 0) = ${fmtInt(s.mainTaxBase)}`);
      lines.push(`–Ω–∞–ª–æ–≥–î–æ = –Ω–∞–ª–æ–≥–ë–∞–∑–∞ √ó 7% = ${fmtInt(s.mainBefore)}`);
    } else {
      lines.push(`(—É–ø—Ä–æ—â–µ–Ω–∏–µ) –Ω–∞–ª–æ–≥–ë–∞–∑–∞ = taxBase = ${fmtInt(s.taxBase)}`);
      lines.push(`–Ω–∞–ª–æ–≥–î–æ = –Ω–∞–ª–æ–≥–ë–∞–∑–∞ √ó 10% = ${fmtInt(s.mainBefore)}`);
    }

    if (state.reg !== "OSNO") {
      lines.push("");
      lines.push("4) –í–∑–Ω–æ—Å—ã –ò–ü 2026:");
      lines.push(`—Ñ–∏–∫—Å = 57 390`);
      lines.push(`–±–∞–∑–∞–î–ª—è1% = ${state.reg === "USN_6" ? "–¥–æ—Ö–æ–¥ (taxBase)" : "–¥–æ—Ö–æ–¥‚àí—Ä–∞—Å—Ö–æ–¥ (–Ω–∞–ª–æ–≥–ë–∞–∑–∞)"} = ${fmtInt(s.baseForExtra)}`);
      lines.push(`1% = min( max(–±–∞–∑–∞–î–ª—è1% ‚àí 300 000, 0) √ó 1%, 321 818 ) = ${fmtInt(s.contribExtra)}`);
      lines.push(`–≤–∑–Ω–æ—Å—ã–ò—Ç–æ–≥–æ = —Ñ–∏–∫—Å + 1% = ${fmtInt(s.contribTotal)}`);

      lines.push("");
      lines.push("5) –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è (–∑–∞—á—ë—Ç) –∏ –Ω–∞–ª–æ–≥ –∫ —É–ø–ª–∞—Ç–µ:");
      lines.push(`–∑–∞—á—ë—Ç = min(–≤–∑–Ω–æ—Å—ã–ò—Ç–æ–≥–æ, –Ω–∞–ª–æ–≥–î–æ) = ${fmtInt(s.credit)}`);
      lines.push(`–Ω–∞–ª–æ–≥–ö–£–ø–ª–∞—Ç–µ = max(–Ω–∞–ª–æ–≥–î–æ ‚àí –∑–∞—á—ë—Ç, 0) = ${fmtInt(s.mainAfter)}`);
    }

    lines.push("");
    lines.push("6) –ò—Ç–æ–≥–æ –∫ —É–ø–ª–∞—Ç–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤—É:");
    lines.push(`–∏—Ç–æ–≥–æ = –ù–î–° + –Ω–∞–ª–æ–≥–ö–£–ø–ª–∞—Ç–µ + –≤–∑–Ω–æ—Å—ã–ò—Ç–æ–≥–æ = ${fmtInt(s.totalPayable)}`);

    lines.push("");
    lines.push("7) –ù–∞ —Ä—É–∫–∏:");
    lines.push(`–Ω–∞–†—É–∫–∏ = —Ü–µ–Ω–∞–ü—Ä–æ–¥–∞–∂–∏ ‚àí –∏—Ç–æ–≥–æ ‚àí –¥–æ–ø–†–∞—Å—Ö–æ–¥—ã = ${fmtInt(r.salePrice)} ‚àí ${fmtInt(s.totalPayable)} ‚àí ${fmtInt(r.extraCosts)} = ${fmtInt(r.netHands)}`);

    if (r.flip.enabled) {
      lines.push("\n‚Äî –ü–µ—Ä–µ–∫—É–ø (–ø–æ—Å–ª–µ –Ω–∞–ª–æ–≥–æ–≤) ‚Äî");
      lines.push(`–≤—ã—Ä—É—á–∫–∞ = —Ü–µ–Ω–∞–ü—Ä–æ–¥–∞–∂–∏ = ${fmtInt(r.salePrice)}`);
      lines.push(`–∑–∞—Ç—Ä–∞—Ç—ã = –ø–æ–∫—É–ø–∫–∞ + –¥–æ–ø–ü–µ—Ä–µ–∫—É–ø + –¥–æ–ø–†–∞—Å—Ö–æ–¥—ã = ${fmtInt(parseMoney($("buyPrice").value))} + ${fmtInt(parseMoney($("flipExtraExpenses").value))} + ${fmtInt(r.extraCosts)} = ${fmtInt(r.flip.costs)}`);
      lines.push(`–Ω–∞–ª–æ–≥–∏/–≤–∑–Ω–æ—Å—ã = –∏—Ç–æ–≥–æ–ö–£–ø–ª–∞—Ç–µ = ${fmtInt(r.flip.taxes)}`);
      lines.push(`–ø—Ä–∏–±—ã–ª—å–ü–æ—Å–ª–µ–ù–∞–ª–æ–≥–æ–≤ = –≤—ã—Ä—É—á–∫–∞ ‚àí –∑–∞—Ç—Ä–∞—Ç—ã ‚àí –Ω–∞–ª–æ–≥–∏ = ${fmtInt(r.flip.profitNet)}`);
      if (r.flip.aprNet !== null) lines.push(`% –≥–æ–¥–æ–≤—ã—Ö = –ø—Ä–∏–±—ã–ª—å/–∑–∞—Ç—Ä–∞—Ç—ã √ó (365/–¥–Ω–µ–π) √ó 100% = ${(r.flip.aprNet*100).toFixed(1)}%`);
    }

    return lines.join("\n");
  }

  // ====== URL sharing ======
  function toShareState(r){
    return {
      addr: r.addr || "",
      sale: r.salePrice || 0,
      cad: r.cadastral || 0,
      band: state.band,
      reg: state.reg,
      expManual: r.expensesManual || 0,
      extra: state.extraExpenses || [],
      flip: state.flip,
      buy: parseMoney($("buyPrice").value) || 0,
      flipDays: parseMoney($("flipDays").value) || 180,
      flipExtra: parseMoney($("flipExtraExpenses").value) || 0
    };
  }

  function encodeState(obj){
    const json = JSON.stringify(obj);
    const b64 = btoa(unescape(encodeURIComponent(json)))
      .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/,"");
    return b64;
  }

  function decodeState(str){
    const b64 = str.replace(/-/g,"+").replace(/_/g,"/");
    const pad = b64 + "===".slice((b64.length + 3) % 4);
    const json = decodeURIComponent(escape(atob(pad)));
    return JSON.parse(json);
  }

  function updateUrl(r){
    const st = toShareState(r);
    const enc = encodeState(st);
    const url = new URL(window.location.href);
    url.searchParams.set("s", enc);
    history.replaceState(null, "", url.toString());
  }

  function loadFromUrl(){
    const url = new URL(window.location.href);
    const s = url.searchParams.get("s");
    if(!s) return;
    try{
      const st = decodeState(s);
      $("addr").value = st.addr || "";
      $("salePrice").value = st.sale ? fmtInt(st.sale) : "";
      $("cadastral").value = st.cad ? fmtInt(st.cad) : "";

      state.band = st.band || "A";
      state.reg = st.reg || "USN_6";
      state.flip = st.flip || "OFF";

      setActive("incomeBand","data-band",state.band);
      setActive("taxRegime","data-reg",state.reg);
      setActive("flipToggle","data-flip",state.flip);

      state.extraExpenses = Array.isArray(st.extra) ? st.extra.map(x=>({name:x.name||"", amount:Number(x.amount)||0})) : [];
      renderExtraExpenses();

      $("expenses").value = st.expManual ? fmtInt(st.expManual) : "";

      $("buyPrice").value = st.buy ? fmtInt(st.buy) : "";
      $("flipDays").value = st.flipDays ? fmtInt(st.flipDays) : "180";
      $("flipExtraExpenses").value = st.flipExtra ? fmtInt(st.flipExtra) : "";

      $("flipBlock").hidden = (state.flip === "OFF");
      $("flipResults").hidden = (state.flip === "OFF");

      applyRegimeRules();
    } catch(e){}
  }

  // ====== Copy ======
  function buildTextForCopy() {
    const r = calcAll();
    const s = r.sale;

    const lines = [];
    lines.push("RBMGROUP.RU");
    lines.push("–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–∞–ª–æ–≥–æ–≤ ‚Äî –ø—Ä–æ–¥–∞–∂–∞ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ (–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥)");
    if (r.addr) lines.push(`–ê–¥—Ä–µ—Å: ${r.addr}`);
    lines.push(`–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏: ${fmtMoney(r.salePrice)}`);
    lines.push(`–ö–∞–¥–∞—Å—Ç—Ä–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${fmtMoney(r.cadastral)}`);
    lines.push(`–ë–∞–∑–∞ –¥–ª—è –Ω–∞–ª–æ–≥–æ–≤ (–°–ü–±): ${fmtMoney(s.taxBase)}`);
    lines.push(`–î–∏–∞–ø–∞–∑–æ–Ω –≤—ã—Ä—É—á–∫–∏: ${bandHuman(state.band)}`);
    lines.push(`–ù–î–°: ${outflow(s.vat)}`);
    lines.push(`–ù–∞–ª–æ–≥ (–¥–æ –∑–∞—á—ë—Ç–∞ –≤–∑–Ω–æ—Å–æ–≤): ${outflow(s.mainBefore)}`);

    if (state.reg !== "OSNO"){
      lines.push(`–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è (–∑–∞—á—ë—Ç) –≤–∑–Ω–æ—Å–∞–º–∏: ${plus(s.credit)}`);
      lines.push(`–í–∑–Ω–æ—Å—ã –ò–ü (–∏—Ç–æ–≥–æ): ${outflow(s.contribTotal)}`);
    } else {
      lines.push(`–ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è (–∑–∞—á—ë—Ç) –≤–∑–Ω–æ—Å–∞–º–∏: ‚Äî`);
      lines.push(`–í–∑–Ω–æ—Å—ã –ò–ü: ‚Äî (–Ω–µ —É—á—Ç–µ–Ω—ã –≤ —É–ø—Ä–æ—â—ë–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏)`);
    }

    lines.push(`–ù–∞–ª–æ–≥ –∫ —É–ø–ª–∞—Ç–µ: ${outflow(s.mainAfter)}`);
    lines.push(`–ò—Ç–æ–≥–æ –∫ —É–ø–ª–∞—Ç–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤—É: ${outflow(s.totalPayable)}`);
    lines.push(`–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã: ${outflow(r.extraCosts)}`);
    lines.push(`–ù–∞ —Ä—É–∫–∏: ${inflow(r.netHands)}`);
    lines.push(`–°—Å—ã–ª–∫–∞ –Ω–∞ —Ä–∞—Å—á—ë—Ç: ${window.location.href}`);
    return lines.join("\n");
  }

  $("copyBtn").addEventListener("click", async () => {
    const text = buildTextForCopy();
    try {
      await navigator.clipboard.writeText(text);
      $("message").innerHTML = `<div class="ok">‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞</div>`;
      setTimeout(() => $("message").innerHTML = "", 1400);
    } catch {
      $("message").innerHTML = `<div class="warn">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ú–æ–∂–Ω–æ –≤—ã–¥–µ–ª–∏—Ç—å —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é.</div>`;
    }
  });

  $("copyLinkBtn").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(window.location.href);
      $("message").innerHTML = `<div class="ok">‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞</div>`;
      setTimeout(() => $("message").innerHTML = "", 1400);
    }catch{
      $("message").innerHTML = `<div class="warn">–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É. –°–∫–æ–ø–∏—Ä—É–π –∏–∑ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.</div>`;
    }
  });

  // ====== render ======
  function render() {
    const r = calcAll();
    const s = r.sale;

    const showContrib = (state.reg !== "OSNO");
    $("contribRow0").style.display = showContrib ? "" : "none";
    $("contribRow1").style.display = showContrib ? "" : "none";
    $("contribRow2").style.display = showContrib ? "" : "none";
    $("contribRow3").style.display = showContrib ? "" : "none";

    $("rTaxBase").textContent = fmtMoney(s.taxBase);
    $("rVatRate").textContent = `${pct(s.vatRate)} (–≤—ã—Ä—É—á–∫–∞: ${bandHuman(state.band)})`;

    $("rVat").textContent = outflow(s.vat);
    $("rMainTaxBefore").textContent = outflow(s.mainBefore);

    $("rContribCredit").textContent = plus(s.credit);

    $("rContribFixed").textContent = outflow(s.contribFixed);
    $("rContribExtra").textContent = outflow(s.contribExtra);
    $("rContribTotal").textContent = outflow(s.contribTotal);

    $("rMainTaxAfter").textContent = outflow(s.mainAfter);
    $("rTotalPayable").textContent = outflow(s.totalPayable);

    const netEl = $("rNetHands");
    if (r.netHands >= 0){
      netEl.textContent = inflow(r.netHands);
      netEl.classList.add("pos"); netEl.classList.remove("neg");
    } else {
      netEl.textContent = outflow(Math.abs(r.netHands));
      netEl.classList.add("neg"); netEl.classList.remove("pos");
    }

    const hint = nearestBandDeltaText(s.taxBase, {
      salePrice: r.salePrice,
      cadastral: r.cadastral,
      regime: state.reg,
      expenses: r.expenses
    });
    $("bandDeltaHint").innerHTML = hint || "";

    $("flipResults").hidden = (state.flip === "OFF");
    if (state.flip === "ON"){
      $("rFlipStatus").textContent = "–≤–∫–ª—é—á–µ–Ω";
      $("rFlipRevenue").textContent = inflow(r.flip.revenue);
      $("rFlipCosts").textContent = outflow(r.flip.costs);
      $("rFlipTaxes").textContent = outflow(r.flip.taxes);

      const profitEl = $("rFlipProfitNet");
      const aprEl = $("rFlipAPR");

      if (r.flip.profitNet >= 0) {
        profitEl.textContent = inflow(r.flip.profitNet);
        profitEl.classList.remove("neg"); profitEl.classList.add("pos");
      } else {
        profitEl.textContent = outflow(Math.abs(r.flip.profitNet));
        profitEl.classList.remove("pos"); profitEl.classList.add("neg");
      }

      if (r.flip.aprNet !== null) {
        const txt = (r.flip.aprNet*100).toFixed(1) + "%";
        aprEl.textContent = txt;
        if (r.flip.aprNet >= 0) { aprEl.classList.add("pos"); aprEl.classList.remove("neg"); }
        else { aprEl.classList.add("neg"); aprEl.classList.remove("pos"); }
      } else {
        aprEl.textContent = "‚Äî";
        aprEl.classList.remove("pos","neg");
      }
    }

    if (state.showFormula) $("formulaBox").textContent = buildFormulaText(r);

    const warnings = [...s.warnings];
    if (warnings.length) {
      $("message").innerHTML = `<div class="warn"><b>–í–∞–∂–Ω–æ:</b><br>‚Ä¢ ${warnings.join("<br>‚Ä¢ ")}</div>`;
    } else {
      $("message").innerHTML = "";
    }

    updateUrl(r);
  }

  // ====== init ======
  function ensureDefaults(){
    if (!$("flipDays").value) $("flipDays").value = "180";
  }

  loadFromUrl();
  ensureDefaults();
  applyRegimeRules();
  renderExtraExpenses();
  render();
</script>
</body>
</html>
